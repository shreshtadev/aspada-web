---
import pb from "../lib/pb";
interface Project {
  id: string;
  name: string;
  slug: string;
  type: string;
  image?: string;
}

const projectsFromBe = await pb.collection("projects").getFullList({
  limit: 3,
  expand: "coverImage",
});
const projects: Project[] = projectsFromBe
  .map((project) => {
    const coverImageUrl = pb.files.getURL(
      project.expand?.coverImage,
      project.expand?.coverImage?.attachment,
      {
        thumb: "1200",
        quality: 80,
      },
    );
    return {
      id: project.id,
      name: project.title,
      slug: project.slug,
      type: project.category,
      image: coverImageUrl,
    };
  })
  .filter((y) => y.image !== "");
---

<section class="py-24 px-6 overflow-hidden">
  <div class="max-w-7xl mx-auto">
    <div class="mb-16 font-display">
      <span
        class="text-aspada-gold font-bold tracking-[0.3em] uppercase text-xs"
        >Portfolio</span
      >
      <h2 class="text-4xl md:text-6xl font-bold mt-4 text-aspada-steel">
        Landmark <span class="text-aspada-gold/70 italic font-light"
          >Creations</span
        >
      </h2>
    </div>

    <div
      class="relative h-[500px] md:h-[650px] perspective-2000"
      id="gallery-stage"
    >
      {
        projects.map((project, i) => (
          <div
            data-project-card
            style={{
              transform: `translateZ(${-i * 120}px) translateY(${i * 12}px)`,
              zIndex: projects.length - i,
            }}
            class="absolute inset-0 w-full h-full transition-all duration-1000 ease-[cubic-bezier(0.23,1,0.32,1)] will-change-transform"
          >
            <div class="relative w-full h-full rounded-3xl overflow-hidden group border border-white/5 bg-aspada-navy">
              <img
                src={project.image}
                alt={project.slug}
                loading="lazy"
                decoding="async"
                class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105 grayscale group-hover:grayscale-0"
              />

              <div class="absolute inset-0 bg-gradient-to-t from-aspada-navy via-aspada-navy/20 to-transparent p-8 md:p-16 flex flex-col justify-end">
                <span class="text-aspada-gold font-bold uppercase tracking-[0.2em] text-xs mb-3">
                  {project.type}
                </span>

                <h3 class="text-4xl md:text-7xl font-bold text-aspada-cream mb-6 tracking-tight">
                  {project.name}
                </h3>
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<style>
  .perspective-2000 {
    perspective: 1600px;
    transform-style: preserve-3d;
  }
</style>

<script>
  function initGallery() {
    const cards = document.querySelectorAll("[data-project-card]");
    const nextBtn = document.getElementById("gal-next");
    const prevBtn = document.getElementById("gal-prev");
    let activeIndex = 0;
    let autoPlayInterval: number | null = null;

    function updateGallery() {
      const MAX_VISIBLE = 3; // current + next 2 only
      cards.forEach((card, i) => {
        const relIndex = (i - activeIndex + cards.length) % cards.length;

        if (relIndex >= MAX_VISIBLE) {
          // Hard hide anything deeper in the stack
          (card as HTMLElement).style.opacity = "0";
          (card as HTMLElement).style.pointerEvents = "none";
          (card as HTMLElement).style.transform =
            "translateZ(-1000px) scale(0.8)";
          (card as HTMLElement).style.zIndex = "0";
          return;
        }

        const isMobile = window.innerWidth < 768;
        const zValue = -relIndex * (isMobile ? 120 : 180);
        const yValue = relIndex * (isMobile ? 20 : 40);
        const scale = 1 - relIndex * 0.06;
        const opacity = relIndex === 0 ? 1 : 0.35;

        (card as HTMLElement).style.transform =
          `translateZ(${zValue}px) translateY(${yValue}px) scale(${scale})`;

        (card as HTMLElement).style.opacity = opacity.toString();
        (card as HTMLElement).style.pointerEvents =
          relIndex === 0 ? "auto" : "none";

        (card as HTMLElement).style.zIndex = (100 - relIndex).toString();
      });
    }

    const nextSlide = () => {
      activeIndex = (activeIndex + 1) % cards.length;
      updateGallery();
    };

    const prevSlide = () => {
      activeIndex = (activeIndex - 1 + cards.length) % cards.length;
      updateGallery();
    };

    // Auto-Play Logic
    const startAutoPlay = () => {
      autoPlayInterval = window.setInterval(nextSlide, 5000); // Changes every 3 seconds
    };

    const stopAutoPlay = () => {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
      }
    };

    // Event Listeners
    nextBtn?.addEventListener("click", () => {
      stopAutoPlay(); // Stop auto-play when user interacts
      nextSlide();
      startAutoPlay(); // Restart timer
    });

    prevBtn?.addEventListener("click", () => {
      stopAutoPlay();
      prevSlide();
      startAutoPlay();
    });

    // Pause on hover
    const stage = document.getElementById("gallery-stage");
    stage?.addEventListener("mouseenter", stopAutoPlay);
    stage?.addEventListener("mouseleave", startAutoPlay);

    // Initial Start
    updateGallery();
    startAutoPlay();
  }

  // Handle Astro page loads & View Transitions
  document.addEventListener("astro:page-load", initGallery);
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    initGallery();
  }
</script>
