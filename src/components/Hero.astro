---
import pb from '../lib/pb'
import type { ProjectExpand } from '../types'
import {
  Collections,
  MetadataCategoryTypeOptions,
  type MetadataResponse,
  type ProjectsResponse,
} from '../types/pocketbase-types'

interface HeroProps {
  projects: ProjectsResponse<ProjectExpand>[]
  index: number
}

const { projects: projectsFromBe } = Astro.props as HeroProps
const count = projectsFromBe.length
const durationPerImage = 5
const totalDuration = count * durationPerImage
const projects = projectsFromBe.map((project) => {
  const coverImageUrl = pb.files.getURL(
    project.expand?.coverImage,
    project.expand?.coverImage?.attachment,
    { thumb: '1200', quality: 80 }
  )
  project.coverImage = coverImageUrl
  return project
})
const metadatas = await pb.collection(Collections.Metadata).getFullList<MetadataResponse>()
const stats = metadatas.filter(
  (metadata) => metadata.categoryType === MetadataCategoryTypeOptions.statsSettings
)
---

<style>
  .slideshow-slide {
    opacity: 0;
    animation: fade var(--total-duration) ease-in-out infinite;
    will-change: opacity, transform;
  }

  .ken-burns {
    animation: kenburns var(--total-duration) linear infinite;
  }

  @keyframes fade {
    0% {
      opacity: 0;
    }
    10% {
      opacity: 1;
    }
    85% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }

  @keyframes kenburns {
    0% {
      transform: scale(1.08) translate3d(0%, 0%, 0);
    }
    100% {
      transform: scale(1.18) translate3d(-4%, -2%, 0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .slideshow-slide,
    .ken-burns {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }

  /* SBR-style outline text effect */
  .text-outline {
    -webkit-text-stroke: 1px rgba(255, 255, 255, 0.6);
    color: transparent;
  }
</style>

<section class="relative h-[110vh] w-full flex items-center overflow-hidden bg-aspada-navy/10">
  <div class="absolute inset-0 overflow-hidden">
    <div class="absolute inset-0" style={`--total-duration: ${totalDuration}s`}>
      {
        projects.map((project, index) => (
          <div
            class="absolute inset-0 slideshow-slide"
            style={{ animationDelay: `${index * durationPerImage}s` }}
          >
            {projects.length === 1 ? (
              <img
                src={projects[0].coverImage}
                alt={projects[0].slug}
                class="absolute inset-0 w-full h-full object-cover ken-burns transform-gpu"
              />
            ) : (
              <img
                src={project.coverImage}
                alt={project.slug}
                class="w-full h-full object-cover ken-burns transform-gpu"
                style={{ animationDelay: `${index * durationPerImage}s` }}
                loading={index === 0 ? 'eager' : 'lazy'}
              />
            )}
          </div>
        ))
      }
    </div>
  </div>

  <div class="absolute right-12 bottom-24 hidden lg:block z-20">
    <div class="flex flex-col gap-10">
      {
        stats.map((stat) => (
          <div class="text-right border-r-4 border-aspada-gold/20 pr-6">
            <p class="text-white font-black text-2xl uppercase tracking-tighter">{stat.summary}</p>
            <p class="text-aspada-cream uppercase text-[10px] font-bold tracking-widest">
              {stat.title}
            </p>
          </div>
        ))
      }
    </div>
  </div>

  <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-20">
    <div class="w-6 h-10 border-2 border-white/30 rounded-full flex justify-center p-1">
      <div class="w-1 h-2 bg-aspada-gold rounded-full animate-bounce"></div>
    </div>
  </div>
</section>
