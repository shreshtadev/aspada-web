---
import pb from "../lib/pb";

interface Testimonial {
  name: string;
  role: string;
  text: string;
  avatar: string;
}
const testimonialsFromBe = await pb.collection("testimonials").getFullList({
  sort: "-created",
  limit: 3,
});
const testimonials = testimonialsFromBe.map((t) => ({
  name: t.authorName,
  role: t.authorRole,
  text: t.content,
  avatar: pb.files.getURL(t, t.authorAvatar),
}));
---

<section class="py-32 px-6 overflow-hidden">
  <div class="max-w-7xl mx-auto grid lg:grid-cols-2 gap-16 items-center">
    <div class="space-y-6">
      <span
        class="text-aspada-gold font-bold tracking-[0.3em] uppercase text-xs"
        >Testimonials</span
      >
      <h2 class="text-5xl font-bold text-aspada-steel tracking-tight">
        Voice of <br />
        <span class="text-aspada-gold/70 italic font-light">Confidence.</span>
      </h2>
      <p class="text-aspada-steel/60 text-lg max-w-md">
        Our legacy is built on the trust of our clients. Tap to shuffle or wait
        to see more stories <a class="text-aspada-gold" href="/testimonials"
          >here</a
        >.
      </p>
    </div>

    <div
      class="relative h-[450px] w-full max-w-md mx-auto lg:mx-0 group"
      id="card-stack"
    >
      {
        testimonials.map((t, i) => (
          <div
            data-testimonial-card
            class="absolute inset-0 bg-white/5 backdrop-blur-xl p-8 rounded-3xl cursor-pointer select-none transition-all duration-500 ease-out border border-white/10 shadow-2xl"
          >
            <div class="flex items-center gap-4 mb-8">
              <img
                src={t.avatar}
                class="w-14 h-14 rounded-full border-2 border-aspada-gold/50 p-1"
                alt={t.name}
              />
              <div>
                <h4 class="font-bold text-aspada-navy text-lg">{t.name}</h4>
                <p class="text-[10px] uppercase text-aspada-gold tracking-[0.2em] font-black">
                  {t.role}
                </p>
              </div>
            </div>
            <div class="relative">
              <div class="i-lucide-quote text-4xl text-[#d4af37]/20 absolute -top-4 -left-2 rotate-180" />
              <p class="text-aspada-steel-200 italic text-xl leading-relaxed relative z-10 pl-4">
                {t.text}
              </p>
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>

<script>
  function setupStack() {
    const cards = document.querySelectorAll("[data-testimonial-card]");
    const stack = document.getElementById("card-stack");
    let currentIndex = 0;
    let autoPlayTimer: number | null = null;
    const INTERVAL_TIME = 5000; // 5 seconds

    function updateStack() {
      cards.forEach((card, i) => {
        const relIndex = (i - currentIndex + cards.length) % cards.length;
        const el = card as HTMLElement;

        el.style.zIndex = `${cards.length - relIndex}`;
        el.style.transform = `translateY(${relIndex * 25}px) scale(${1 - relIndex * 0.05})`;
        el.style.opacity = relIndex > 2 ? "0" : `${1 - relIndex * 0.3}`;
        el.style.pointerEvents = relIndex === 0 ? "auto" : "none";
        el.style.filter = relIndex === 0 ? "blur(0px)" : "blur(2px)";
      });
    }

    function rotate() {
      const topCard = cards[currentIndex] as HTMLElement;

      // The "Throw" Animation
      topCard.style.transform = "translateX(120%) rotate(20deg)";
      topCard.style.opacity = "0";

      setTimeout(() => {
        currentIndex = (currentIndex + 1) % cards.length;
        updateStack();
      }, 300);
    }

    // Auto-play management
    function startAutoPlay() {
      if (!autoPlayTimer) {
        autoPlayTimer = window.setInterval(rotate, INTERVAL_TIME);
      }
    }

    function stopAutoPlay() {
      if (autoPlayTimer) {
        clearInterval(autoPlayTimer);
        autoPlayTimer = null;
      }
    }

    // Manual Interaction
    stack?.addEventListener("click", () => {
      stopAutoPlay();
      rotate();
      startAutoPlay(); // Restart timer after click
    });

    // Pause on hover
    stack?.addEventListener("mouseenter", stopAutoPlay);
    stack?.addEventListener("mouseleave", startAutoPlay);

    // Initial setup
    updateStack();
    startAutoPlay();
  }

  // Handle Astro page loads & View Transitions
  document.addEventListener("astro:page-load", setupStack);
  if (
    document.readyState === "complete" ||
    document.readyState === "interactive"
  ) {
    setupStack();
  }
</script>
