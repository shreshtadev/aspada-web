---
import Layout from '../layouts/Layout.astro'
import Navbar from '../components/Navbar.astro'
import Hero from '../components/Hero.svelte'
import ActionDock from '../components/ActionDock.astro'
import Address from '../components/Address.astro'
import Testimonials from '../components/Testimonials.astro'
import Footer from '../components/Footer.astro'
import ProjectGallery from '../components/ProjectGallery.svelte'
import LoadingSection from '../components/LoadingSection.astro'
import pb from '../lib/pb'
import ProjectCategory from '../components/ProjectCategory.astro'
import {
  Collections,
  MetadataCategoryTypeOptions,
  ProjectsStatusOptions,
  type ProjectsResponse,
  type MetadataResponse,
} from '../types/pocketbase-types'
import type { ProjectExpand } from '../types'
import StatsSection from '../components/StatsSection.svelte'

const projects = await pb
  .collection(Collections.Projects)
  .getFullList<ProjectsResponse<ProjectExpand>>({
    limit: 10,
    expand: 'coverImage,projectDetails',
  })

const stats = await pb.collection(Collections.Metadata).getFullList<MetadataResponse>({
  filter: `categoryType = "${MetadataCategoryTypeOptions.statsSettings}"`,
})

const ongoingProjects = projects.filter(
  (project) => project.status === ProjectsStatusOptions.ongoing
)

const companyProfile = await pb
  .collection(Collections.Companies)
  .getFirstListItem("companyName = '" + import.meta.env.PUBLIC_COMPANY_NAME + "'")
const mapsUrl = 'https://maps.app.goo.gl/ByMKK3ayuos1PQQt8'
---

<Layout title="Aspada Developers | Shivamogga's Finest">
  <Navbar companyProfile={companyProfile} />

  <main>
    <Hero client:load projects={ongoingProjects} />
    <StatsSection client:load stats={stats} />
    <LoadingSection
      sectionId="portfolio"
      skeletonCount={3}
      minHeight="600px"
      class="py-16 px-4 sm:py-24 sm:px-6"
    >
      <ProjectGallery client:load projects={ongoingProjects} />
      <ProjectCategory />
    </LoadingSection>

    <LoadingSection
      sectionId="testimonials"
      skeletonCount={1}
      minHeight="400px"
      class="py-6 px-4 sm:py-8 sm:px-6"
    >
      <Testimonials />
    </LoadingSection>
    <Address mapsUrl={mapsUrl} />
  </main>
  <Footer companyProfile={companyProfile} />
  <ActionDock companyProfile={companyProfile} />
  <!-- <AspadaChat client:idle /> -->
</Layout>
