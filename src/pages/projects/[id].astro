---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import ActionDock from "../../components/ActionDock.astro";
import SocialEmbed from "../../components/SocialEmbed.svelte";
import pb from "../../lib/pb";
import { getLocationName } from "../../lib/utils";

const { id } = Astro.params;

if (!id) {
    return Astro.redirect("/projects");
}

let project;
let galleryImages: any[] = [];
let amenities: any[] = [];
let specifications: any[] = [];
let socials: any[] = [];
let brochureUrl = "";

try {
    const record = await pb.collection("projects").getOne(id, {
        expand: "amenities,specifications,socials",
    });

    // Process Cover Image
    const coverImageUrl = pb.files.getURL(record, record.coverImage, {
        quality: 90,
    });

    // Process Gallery Images (if any)
    if (record.gallery && Array.isArray(record.gallery)) {
        galleryImages = record.gallery.map((img) =>
            pb.files.getURL(record, img, { quality: 80, thumb: "1200x800" }),
        );
    }

    // Process Brochure
    if (record.brochure) {
        brochureUrl = pb.files.getURL(record, record.brochure);
    }

    // Process Relations
    if (record.expand) {
        amenities = record.expand.amenities || [];
        specifications = record.expand.specifications || [];
        socials = record.expand.socials || [];
    }

    project = {
        id: record.id,
        name: record.title,
        slug: record.slug,
        type: record.category || "Residential",
        image: coverImageUrl,
        location:
            (await getLocationName(
                record.location?.lat,
                record.location?.lon,
            )) || "",
        status: record.status || "Ongoing",
        price: record.price || "",
        fullDescription: record.description,
    };
} catch (e) {
    console.error("Error fetching project:", e);
    return Astro.redirect("/404");
}
---

<Layout title={`${project.name} | Aspada Developers`}>
    <Navbar />

    <main class="min-h-screen bg-slate-50">
        {/* Hero Section */}
        <div class="relative h-[70vh] w-full overflow-hidden">
            <div
                class="absolute inset-0 bg-gradient-to-b from-slate-900/60 via-slate-900/40 to-slate-900/90 z-10"
            >
            </div>
            <img
                src={project.image}
                alt={project.name}
                class="w-full h-full object-cover"
            />
            <div
                class="absolute inset-0 z-20 flex flex-col justify-end pb-20 px-6 sm:px-12 max-w-7xl mx-auto w-full"
            >
                <div
                    class="space-y-4 animate-in slide-in-from-bottom-10 fade-in duration-700"
                >
                    <div class="flex items-center gap-3">
                        <span
                            class="px-4 py-1.5 rounded-full bg-[#d4af37] text-white font-bold text-xs tracking-widest uppercase"
                        >
                            {project.type}
                        </span>
                        <span
                            class={`px-4 py-1.5 rounded-full font-bold text-xs tracking-widest uppercase backdrop-blur-md ${
                                project.status === "Completed"
                                    ? "bg-green-500/20 text-green-400 border border-green-500/30"
                                    : "bg-yellow-500/20 text-yellow-400 border border-yellow-500/30"
                            }`}
                        >
                            {project.status}
                        </span>
                    </div>

                    <h1
                        class="text-5xl md:text-7xl font-bold text-white tracking-tight drop-shadow-2xl"
                    >
                        {project.name}
                    </h1>

                    {
                        project.location && (
                            <div class="flex items-center gap-2 text-slate-300 text-lg">
                                <span class="i-lucide-map-pin text-[#d4af37]" />
                                <span>{project.location}</span>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>

        {/* Action Bar */}
        <div
            class="sticky top-20 z-30 bg-white/80 backdrop-blur-xl border-b border-slate-200"
        >
            <div
                class="max-w-7xl mx-auto px-6 py-4 flex flex-wrap justify-between items-center gap-4"
            >
                <div class="flex gap-6 text-sm font-semibold text-slate-600">
                    <a
                        href="#overview"
                        class="hover:text-[#d4af37] transition-colors"
                        >Overview</a
                    >
                    {
                        amenities.length > 0 && (
                            <a
                                href="#amenities"
                                class="hover:text-[#d4af37] transition-colors"
                            >
                                Amenities
                            </a>
                        )
                    }
                    {
                        specifications.length > 0 && (
                            <a
                                href="#specifications"
                                class="hover:text-[#d4af37] transition-colors"
                            >
                                Specifications
                            </a>
                        )
                    }
                    {
                        galleryImages.length > 0 && (
                            <a
                                href="#gallery"
                                class="hover:text-[#d4af37] transition-colors"
                            >
                                Gallery
                            </a>
                        )
                    }
                </div>

                <div class="flex gap-3">
                    {
                        brochureUrl && (
                            <a
                                href={brochureUrl}
                                target="_blank"
                                class="px-4 py-2 text-sm font-bold text-slate-700 hover:text-[#d4af37] border border-slate-300 rounded-lg hover:bg-slate-50 transition-all flex items-center gap-2"
                            >
                                <span class="i-lucide-download" />
                                Download Brochure
                            </a>
                        )
                    }
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-20">
            <div class="grid lg:grid-cols-3 gap-16">
                {/* Main Content */}
                <div class="lg:col-span-2 space-y-24">
                    {/* Overview */}
                    <section id="overview" class="scroll-mt-32">
                        <h2
                            class="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3"
                        >
                            <span class="w-8 h-1 bg-[#d4af37]"></span>
                            Project Overview
                        </h2>
                        <div
                            class="prose prose-lg prose-slate max-w-none prose-headings:font-bold prose-headings:text-slate-800 prose-p:text-slate-600 prose-li:text-slate-600"
                            set:html={project.fullDescription}
                        />
                    </section>

                    {/* Amenities */}
                    {
                        amenities.length > 0 && (
                            <section id="amenities" class="scroll-mt-32">
                                <h2 class="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3">
                                    <span class="w-8 h-1 bg-[#d4af37]" />
                                    Premium Amenities
                                </h2>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                                    {amenities.map((item) => (
                                        <div class="group p-6 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:border-[#d4af37]/30 transition-all duration-300">
                                            <div class="w-10 h-10 rounded-full bg-[#d4af37]/10 flex items-center justify-center text-[#d4af37] mb-4 group-hover:bg-[#d4af37] group-hover:text-white transition-colors">
                                                <span class="i-lucide-check w-5 h-5" />
                                            </div>
                                            <h3 class="font-bold text-aspada-steel/80 group-hover:text-aspada-steel transition-colors">
                                                {item.title}
                                            </h3>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )
                    }

                    {/* Specifications */}
                    {
                        specifications.length > 0 && (
                            <section id="specifications" class="scroll-mt-32">
                                <h2 class="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3">
                                    <span class="w-8 h-1 bg-[#d4af37]" />
                                    Specifications
                                </h2>
                                <div class="grid md:grid-cols-2 gap-8">
                                    {specifications.map((item) => (
                                        <div class="bg-white p-6 rounded-2xl border-l-4 border-[#d4af37] shadow-sm flex flex-col">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-lg text-aspada-steel mb-2">
                                                    {item.title}
                                                </h3>
                                                <p class="text-aspada-steel text-sm leading-relaxed mb-4">
                                                    {item.details}
                                                </p>
                                            </div>

                                            {/* Attachments Section */}
                                            {item.attachments?.length > 0 && (
                                                <div class="flex flex-wrap gap-2 mt-4">
                                                    <pre>
                                                        {item.attachments}
                                                    </pre>
                                                    {item.attachments.map(
                                                        (file: string) => (
                                                            <img
                                                                src={pb.files.getURL(
                                                                    item,
                                                                    file,
                                                                )}
                                                                alt={item.title}
                                                                class="w-45 h-45 object-cover rounded-lg border border-gray-100"
                                                                loading="lazy"
                                                                decoding="async"
                                                            />
                                                        ),
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )
                    }

                    {/* Gallery */}
                    {
                        galleryImages.length > 0 && (
                            <section id="gallery" class="scroll-mt-32">
                                <h2 class="text-3xl font-bold text-slate-800 mb-8 flex items-center gap-3">
                                    <span class="w-8 h-1 bg-[#d4af37]" />
                                    Gallery
                                </h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {galleryImages.map((img, i) => (
                                        <div class="rounded-2xl overflow-hidden aspect-video group cursor-zoom-in relative">
                                            <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors z-10" />
                                            <img
                                                src={img}
                                                alt={`${project.name} view ${i + 1}`}
                                                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                                loading="lazy"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )
                    }
                </div>

                {/* Sidebar */}
                <div class="space-y-8">
                    {/* Quick Info Card */}
                    <div
                        class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100 sticky top-32"
                    >
                        <div class="pb-6 mb-6 border-b border-slate-100">
                            <h3 class="text-xl font-bold text-slate-800">
                                At a Glance
                            </h3>
                        </div>

                        <div class="space-y-6">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"
                                >
                                    <span class="i-lucide-home"></span>
                                </div>
                                <div>
                                    <p
                                        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                                    >
                                        Type
                                    </p>
                                    <p
                                        class="font-semibold text-slate-800 uppercase"
                                    >
                                        {project.type}
                                    </p>
                                </div>
                            </div>

                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500"
                                >
                                    <span class="i-lucide-activity"></span>
                                </div>
                                <div>
                                    <p
                                        class="text-xs font-bold text-slate-400 uppercase tracking-wider"
                                    >
                                        Status
                                    </p>
                                    <p
                                        class="font-semibold text-slate-800 uppercase"
                                    >
                                        {project.status}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button
                            class="w-full mt-8 bg-aspada-navy text-aspada-cream py-4 rounded-xl font-bold hover:scale-105 transition-transform shadow-lg shadow-aspada-navy/20 cursor-pointer"
                        >
                            Enquire Now
                        </button>
                    </div>

                    {/* Socials Media Embeds */}
                    {
                        socials.length > 0 && (
                            <div class="space-y-6">
                                <h3 class="font-bold text-slate-800 px-2">
                                    Social Updates
                                </h3>
                                {socials.map((social) => (
                                    <SocialEmbed
                                        client:visible
                                        title={social.title}
                                        shareUrl={social.shareUrl}
                                        shareUrlType={social.shareUrlType}
                                    />
                                ))}
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </main>

    <Footer />
    <ActionDock />
</Layout>
