---
import Layout from "../../../layouts/Layout.astro";
import Navbar from "../../../components/Navbar.astro";
import Footer from "../../../components/Footer.astro";
import ActionDock from "../../../components/ActionDock.astro";
import ProjectList from "../../../components/projects/ProjectList.astro";
import pb from "../../../lib/pb";
import toast from "svelte-french-toast";
import {
  Collections,
  ProjectsCategoryOptions,
  ProjectsStatusOptions,
  type CompaniesResponse,
  type ProjectsResponse,
} from "../../../types/pocketbase-types";
import type { ProjectExpand } from "../../../types";

// Fetch projects
// Using fullList to get all projects for the index page.
// Can be paginated if needed later.
let upcomingProjects: any[] = [];
let ongoingProjects: any[] = [];
let completedProjects: any[] = [];
let projects: any[] = [];
const { category } = Astro.params;
let companyProfile: CompaniesResponse;
try {
  const records = await pb
    .collection(Collections.Projects)
    .getFullList<ProjectsResponse<ProjectExpand>>({
      sort: "-created",
      expand: "coverImage,projectDetails",
      filter: `category = "${category}"`,
    });

  projects = records.map((record) => {
    const coverImageUrl = pb.files.getURL(
      record.expand?.coverImage,
      record.expand?.coverImage?.attachment,
      {
        thumb: "800x600",
        quality: 80,
      }
    );

    return {
      id: record.id,
      title: record.title,
      slug: record.slug,
      category: record.category || ProjectsCategoryOptions.residential,
      coverImage: coverImageUrl,
      description: record.description,
      city: record.city,
      district: record.district,
      status: record.status,
      projectDetails: record.expand?.projectDetails,
    };
  });
} catch (e) {
  console.error(e);
  toast.error("Error fetching projects");
}
ongoingProjects = projects.filter(
  (p) => p.status === ProjectsStatusOptions.ongoing
);
upcomingProjects = projects.filter(
  (p) => p.status === ProjectsStatusOptions.upcoming
);
completedProjects = projects.filter(
  (p) => p.status === ProjectsStatusOptions.completed
);

companyProfile = await pb.collection(Collections.Companies).getFirstListItem("companyName = '" + import.meta.env.PUBLIC_COMPANY_NAME + "'");
---

<Layout title="Our Projects | Aspada Developers">
  <Navbar companyProfile={companyProfile} />

  <main class="pt-24 pb-12 px-4 sm:pt-32 sm:pb-20 sm:px-6 min-h-screen">
    <div class="max-w-7xl mx-auto">
      <div class="mb-20 text-center max-w-3xl mx-auto">
        <span
          class="text-aspada-navy/70 font-bold tracking-[0.3em] uppercase text-xl sm:text-2xl"
          >Projects</span
        >
        <h1
          class="text-3xl sm:text-5xl md:text-7xl font-semibold mt-6 text-aspada-steel mb-8"
        >
          Ongoing<span class="text-aspada-gold/70 italic font-light"
            >Projects</span
          >
        </h1>
        <p class="text-aspada-steel/60 text-lg sm:text-xl leading-relaxed">
          Explore our projects of meticulously crafted residential layouts and
          commercial spaces that redefine modern living.
        </p>
      </div>

      {
        ongoingProjects.length > 0 ? (
          <ProjectList projects={ongoingProjects} />
        ) : (
          <div class="text-center py-20 bg-aspada-silver/5 rounded-3xl border border-white/10">
            <p class="text-aspada-steel/50 text-xl">
              No projects found at the moment.
            </p>
            <p class="text-sm mt-2 text-aspada-steel/40">
              Please check back soon.
            </p>
          </div>
        )
      }

      {
        completedProjects.length > 0 && (
                <div class="mb-20 text-center max-w-3xl mx-auto">
        <h1
          class="text-3xl sm:text-5xl md:text-7xl font-semibold mt-6 text-aspada-steel mb-8"
        >
          Completed<span class="text-aspada-gold/70 italic font-light"
            >Projects</span
          >
        </h1>
      </div>
      <div>
          <ProjectList projects={completedProjects} />
      </div>
        )
      }
      {
        upcomingProjects.length > 0 && (
                <div class="mb-20 text-center max-w-3xl mx-auto">
        <h1
          class="text-3xl sm:text-5xl md:text-7xl font-semibold mt-6 text-aspada-steel mb-8"
        >
          Upcoming<span class="text-aspada-gold/70 italic font-light"
            >Projects</span
          >
        </h1>
      </div>
      <div>
          <ProjectList projects={upcomingProjects} />
      </div>
        )
      }
    </div>
  </main>

  <Footer companyProfile={companyProfile} />
  <ActionDock companyProfile={companyProfile} />
</Layout>
