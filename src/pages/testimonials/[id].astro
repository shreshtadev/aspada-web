---
import Layout from "../../layouts/Layout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";
import pb from "../../lib/pb";

export const prerender = false;

const { id } = Astro.params;

let testimonial;
let project;
if (id === undefined) {
    return Astro.redirect("/404");
}

try {
    testimonial = await pb.collection("testimonials").getOne(String(id), {
        expand: "project",
    });
    project = testimonial.expand?.project;
} catch (e) {
    console.error("Error fetching testimonial:", e);
    return Astro.redirect("/404");
}

const avatarUrl = testimonial.authorAvatar
    ? pb.files.getURL(testimonial, testimonial.authorAvatar)
    : "https://i.pravatar.cc/150?u=" + testimonial.id;
---

<Layout title={`${testimonial.authorName} - Testimonial | Aspada Developers`}>
    <Navbar />

    <main class="min-h-screen bg-slate-50 flex flex-col">
        <!-- Breadcrumb / Header -->
        <div class="bg-aspada-navy py-12 px-6">
            <div class="max-w-4xl mx-auto">
                <a
                    href="/testimonials"
                    class="text-slate-400 hover:text-[#d4af37] transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-widest"
                >
                    ← Back to All Stories
                </a>
            </div>
        </div>

        <div class="flex-1 flex items-center justify-center py-12 px-6">
            <div class="max-w-4xl w-full">
                <div
                    class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-[#d4af37]/20 relative"
                >
                    <!-- Decorative Quote -->
                    <div
                        class="absolute top-0 right-0 p-12 opacity-5 pointer-events-none"
                    >
                        <svg
                            width="200"
                            height="200"
                            viewBox="0 0 24 24"
                            fill="currentColor"
                            class="text-[#d4af37]"
                        >
                            <path
                                d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H15.017C14.4647 8 14.017 8.44772 14.017 9V11C14.017 11.5523 13.5693 12 13.017 12H12.017V5H22.017V15C22.017 18.3137 19.3307 21 16.017 21H14.017ZM5.0166 21L5.0166 18C5.0166 16.8954 5.91203 16 7.0166 16H10.0166C10.5689 16 11.0166 15.5523 11.0166 15V9C11.0166 8.44772 10.5689 8 10.0166 8H6.0166C5.46432 8 5.0166 8.44772 5.0166 9V11C5.0166 11.5523 4.56889 12 4.0166 12H3.0166V5H13.0166V15C13.0166 18.3137 10.3303 21 7.0166 21H5.0166Z"
                            ></path>
                        </svg>
                    </div>

                    <div class="grid md:grid-cols-[1fr,2fr] min-h-[400px]">
                        <!-- Sidebar / Author Info -->
                        <div
                            class="bg-slate-900 p-10 flex flex-col items-center text-center justify-center relative overflow-hidden"
                        >
                            <div class="absolute inset-0 bg-[#d4af37]/10"></div>

                            <div class="relative z-10">
                                <img
                                    src={avatarUrl}
                                    alt={testimonial.authorName}
                                    class="w-32 h-32 rounded-full object-cover border-4 border-[#d4af37]/50 shadow-xl mb-6"
                                />
                                <h1 class="text-2xl font-bold text-white mb-2">
                                    {testimonial.authorName}
                                </h1>

                                <div
                                    class="flex text-[#d4af37] justify-center gap-1 mb-6 text-lg"
                                >
                                    {
                                        Array.from({
                                            length: testimonial.rating,
                                        }).map(() => "★")
                                    }
                                    {
                                        Array.from({
                                            length: 5 - testimonial.rating,
                                        }).map(() => "☆")
                                    }
                                </div>

                                {
                                    project && (
                                        <div class="inline-block bg-white/10 backdrop-blur px-4 py-2 rounded-lg border border-white/10">
                                            <span class="block text-xs text-slate-400 uppercase tracking-widest mb-1">
                                                Project
                                            </span>
                                            <span class="text-aspada-cream font-medium">
                                                {project.title}
                                            </span>
                                        </div>
                                    )
                                }
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-10 md:p-14 flex items-center bg-white">
                            <div>
                                <p
                                    class="text-xl md:text-2xl text-slate-700 italic leading-relaxed font-light"
                                >
                                    "{testimonial.content}"
                                </p>

                                <div
                                    class="mt-8 pt-8 border-t border-slate-100"
                                >
                                    <span class="text-sm text-slate-400">
                                        Trusted Client since {
                                            new Date(
                                                testimonial.created,
                                            ).getFullYear()
                                        }
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <Footer />
</Layout>
